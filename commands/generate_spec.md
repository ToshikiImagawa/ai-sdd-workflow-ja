---
name: generate_spec
description: "入力された内容から抽象仕様書（Specification）と技術設計書（Design Doc）を生成する"
---

# Specification & Design Doc Generator

入力された内容から AI-SDD ワークフローに従って以下のドキュメントを生成します：

1. `.docs/specification/{機能名}_spec.md` - 抽象仕様書（Specify フェーズ）
2. `.docs/specification/{機能名}_design.md` - 技術設計書（Plan フェーズ）

## 前提条件

**sdd-workflow エージェントの原則に従って生成を行います。**

生成前に以下を確認してください：

1. プロジェクトに `.docs/` ディレクトリが存在するか
2. テンプレートファイルが存在する場合はそれを使用

## 入力

$ARGUMENTS

## 入力例

```
/generate_spec ユーザー認証機能。
メールアドレスとパスワードによるログイン・ログアウトに対応。
パスワードリセット機能を提供し、セッション管理はJWTトークンで行う。
ログイン状態を確認するAPIと、認証が必要なエンドポイントを保護するミドルウェアを提供する。
```

## 生成ルール

### 1. Vibe Coding リスク評価（最初に実施）

入力内容を分析し、以下の基準でリスクを評価してください：

| リスク  | 条件            | 対応                 |
|:-----|:--------------|:-------------------|
| 🔴 高 | 仕様書なし + 曖昧な指示 | 不足情報をユーザーに確認してから生成 |
| 🟡 中 | 一部の要件が曖昧      | 曖昧な箇所を明確化してから生成    |
| 🟢 低 | 要件が明確         | そのまま生成可能           |

**曖昧な入力の例**:

- 「いい感じに実装して」「適当に」→ 具体的な要件を確認
- 「パフォーマンスを上げて」→ 対象と目標値を確認
- 「前と同じように」→ 参照先を確認

### 2. 入力内容の分析

入力から以下を抽出・推測してください：

**Spec（抽象仕様書）用**:

| 抽出項目       | 説明                | 必須 |
|:-----------|:------------------|:---|
| **機能名**    | ファイル名に使用する識別名     | ✅  |
| **背景**     | なぜこの機能が必要か        | ✅  |
| **目的**     | 何を実現するか           | ✅  |
| **機能要件**   | 必要な機能のリスト         | ✅  |
| **公開API**  | ユーザーが使用するインターフェース |    |
| **データモデル** | 主要な型・エンティティ       |    |
| **振る舞い**   | 主要なユースケース・シーケンス   |    |

**Design Doc（技術設計書）用**:

| 抽出項目         | 説明               | 必須 |
|:-------------|:-----------------|:---|
| **技術スタック**   | 使用する技術・ライブラリ     | ✅  |
| **アーキテクチャ案** | モジュール構成・レイヤー設計   | ✅  |
| **設計判断**     | 技術選定の理由・代替案      |    |
| **非機能要件**    | パフォーマンス・セキュリティ要件 |    |

### 3. 不足情報の確認

入力から判断できない重要な項目がある場合、**生成前に**ユーザーに確認してください：

- 機能の名前が不明
- 必須の抽出項目が入力から推測できない
- 技術スタックの指定がない（既存パターンを踏襲するか確認）
- 曖昧なビジネスルールやエッジケース

### 4. 既存ドキュメントの確認

生成前に以下を確認してください：

```
.docs/requirement-diagram/{機能名}.md が存在するか？（PRD）
.docs/specification/{機能名}_spec.md が既に存在するか？
.docs/specification/{機能名}_design.md が既に存在するか？
```

**PRDが存在する場合**:

- PRDを事前に読み込み、要求ID（UR-xxx, FR-xxx, NFR-xxx）と機能要求を把握
- 生成するspecがPRDの要求を網羅するようにする
- specの「機能要件」セクションでPRDの要求IDを参照

**spec/designが存在する場合**: ユーザーに上書きするか確認してください。

## 出力形式

### Phase 1: 抽象仕様書（Specify フェーズ）

プロジェクトにテンプレート（`.docs/SPECIFICATION_TEMPLATE.md`）が存在する場合はそれに従ってください。
存在しない場合は以下の構成で生成してください：

```markdown
# {機能名} 仕様書

## 背景

なぜこの機能が必要か

## 概要

何を実現するか

## 機能要件

- 要件1
- 要件2

## API

公開インターフェースの定義

## データモデル

主要な型定義
```

**保存先**: `.docs/specification/{機能名}_spec.md`

### Phase 2: 技術設計書（Plan フェーズ）

抽象仕様書の生成完了後、技術設計書を生成してください。
プロジェクトにテンプレート（`.docs/DESIGN_DOC_TEMPLATE.md`）が存在する場合はそれに従ってください。

**Design Doc で記載すべき内容**:

| セクション      | 内容               | 必須 |
|:-----------|:-----------------|:---|
| 実装ステータス    | 初期は 🔴 未実装       | ✅  |
| 設計目標       | 達成すべき技術目標        | ✅  |
| 技術スタック     | 採用技術と選定理由        | ✅  |
| アーキテクチャ    | システム構成図・モジュール分割  | ✅  |
| 設計判断       | 決定事項・選択肢・理由      | ✅  |
| データモデル     | 具体的な型定義          |    |
| インターフェース定義 | 各レイヤーのインターフェース定義 |    |
| テスト戦略      | テストレベル・カバレッジ目標   |    |

**保存先**: `.docs/specification/{機能名}_design.md`

### Design Doc 生成をスキップする場合

以下の場合は Design Doc の生成をスキップし、ユーザーに確認してください：

- 入力に技術的な情報が全くない
- 既存の設計パターンを踏襲するか不明
- 調査・検討が必要な技術選定がある

## 生成フロー

```
1. 入力内容を分析
   ↓
2. Vibe Coding リスク評価
   ├─ 🔴 高: 不足情報をユーザーに確認 → 回答後に再開
   ├─ 🟡 中: 曖昧な箇所を確認 → 回答後に再開
   └─ 🟢 低: 次のステップへ
   ↓
3. 既存ドキュメントの確認
   ├─ PRDが存在する場合: 事前に読み込み、要求を把握
   └─ spec/designが存在する場合: 上書き確認
   ↓
4. 抽象仕様書を生成・保存（Specify）
   ↓
5. PRDとの整合性レビュー（PRDが存在する場合）
   ├─ 整合している: 次のステップへ
   └─ 不整合あり: specを修正して再保存
   ↓
6. Design Doc 生成の確認
   ├─ 技術情報あり: 生成・保存（Plan）
   └─ 技術情報なし: スキップするか確認
   ↓
7. コミット
```

## PRDとの整合性レビュー

PRDが存在する場合、生成したspecに対して以下の整合性チェックを行い、結果をspecに反映してください：

### チェック項目

| チェック項目       | 確認内容                               |
|:-------------|:-----------------------------------|
| **要求の網羅性**   | PRDの機能要求（FR-xxx）がすべてspecでカバーされているか |
| **要求IDの参照**  | specの機能要件でPRDの要求IDを適切に参照しているか      |
| **非機能要求の反映** | PRDの非機能要求（NFR-xxx）がspecに反映されているか   |
| **用語の一致**    | PRDとspecで同じ用語が使用されているか             |

### 不整合検出時の対応

1. **欠落している要求**: specに該当する機能要件を追加
2. **要求IDの未参照**: 機能要件に対応する要求IDを追記
3. **用語の不一致**: PRDの用語に統一

### 整合性レビュー結果の記載

specの末尾に以下を追記（PRDが存在する場合）：

```markdown
## PRD参照

- 対応PRD: `.docs/requirement-diagram/{機能名}.md`
- カバーする要求: UR-001, FR-001, FR-002, NFR-001, ...
```

## 生成後のアクション

1. **ファイル保存**:
    - `.docs/specification/{機能名}_spec.md`
    - `.docs/specification/{機能名}_design.md`（生成した場合）

2. **整合性チェック**:
    - PRDが存在する場合: PRD ↔ spec の整合性を確認・反映
    - spec ↔ design の整合性を確認

3. **コミット**:
    - Spec のみ: `[spec] {機能名}の抽象仕様書を追加`
    - 両方: `[docs] {機能名}の抽象仕様書と技術設計書を追加`

## Serena MCP 統合（オプション）

Serena MCP が有効な場合、既存コードベースのセマンティック分析を活用して仕様書生成を強化できます。

### 利用条件

- `.mcp.json` に `serena` が設定されていること
- 対象言語の Language Server がサポートされていること

### Serena 有効時の追加機能

#### 既存コードからの仕様抽出

| 機能                         | 活用方法                        |
|:---------------------------|:----------------------------|
| `find_symbol`              | 既存の関数・クラス定義を検索し、API仕様の参考にする |
| `find_referencing_symbols` | 既存コードの使用パターンから振る舞いを推測       |

#### 生成強化項目

1. **既存API参照**: 類似機能の既存実装を参照し、一貫性のあるAPI設計を提案
2. **型定義の参照**: プロジェクト内の既存型を検索し、データモデルに反映
3. **命名規則の統一**: 既存コードの命名パターンを分析し、新機能の命名に反映
4. **依存関係の把握**: 関連モジュールを特定し、インターフェース設計に活用

#### 生成フローへの統合

```
1. 入力内容を分析
   ↓
2. [Serena有効時] 既存コードベースを分析
   ├─ 類似機能の検索
   ├─ 既存型・インターフェースの把握
   └─ 命名規則の抽出
   ↓
3. Vibe Coding リスク評価
   ...
```

### Serena 未設定時の動作

Serena が利用できない場合でも、入力内容とPRDに基づいて仕様書を生成します。
既存コードの参照は手動で行う必要があります。
