---
name: check_spec
description: "実装コードと仕様書の整合性をチェックし、差異を検出する"
---

# Check Spec - 仕様書整合性チェック

実装コードと仕様書（`*_spec.md`, `*_design.md`）の整合性を確認し、差異を検出します。

## 前提条件

**sdd-workflow エージェントの原則に従って整合性チェックを行います。**

### ドキュメント間の依存関係（参照）

```
実装 → *_design.md → *_spec.md → requirement-diagram/
```

## 入力

$ARGUMENTS

### 入力例

```
/check_spec user-auth
/check_spec task-management
/check_spec  # 引数なしの場合は全仕様書を対象
```

## 処理フロー

### 1. 対象ドキュメントの特定

```
引数あり → 以下のファイルを対象:
  - .docs/requirement-diagram/{引数}.md（PRD、存在する場合）
  - .docs/specification/{引数}_spec.md
  - .docs/specification/{引数}_design.md
引数なし → .docs/specification/ 配下の全ファイルを対象
```

### 2. ドキュメントの読み込み

対象のドキュメントから以下の情報を抽出：

**PRD（`requirement-diagram/*.md`）から抽出**（存在する場合）:

| 項目        | 説明                        |
|:----------|:--------------------------|
| **要求ID**  | UR-xxx, FR-xxx, NFR-xxx   |
| **機能要求**  | システムが提供すべき機能              |
| **非機能要求** | パフォーマンス、セキュリティ等           |

**`*_spec.md` から抽出**:

| 項目         | 説明           |
|:-----------|:-------------|
| **公開API**  | 関数名、引数、戻り値の型 |
| **データモデル** | 型定義、インターフェース |
| **機能要件**   | 実装すべき機能のリスト  |
| **PRD参照**  | 参照している要求ID   |

**`*_design.md` から抽出**:

| 項目             | 説明                 |
|:---------------|:-------------------|
| **モジュール構成**    | ディレクトリ構造、ファイル構成    |
| **技術スタック**     | 使用ライブラリ、フレームワーク    |
| **インターフェース定義** | 各レイヤーのインターフェース定義   |

### 3. 実装コードの確認

仕様書に記載された内容に対応するコードを検索：

- API・関数の検索（プロジェクトの言語に応じた方法で検索）
- 型定義・データモデルの検索
- モジュール・ファイルの存在確認

### 4. 整合性チェック項目

#### PRD ↔ spec の整合性（PRDが存在する場合）

| チェック対象       | 確認内容                       | 重要度 |
|:-------------|:---------------------------|:----|
| **要求IDの対応**  | PRDの要求IDがspecで参照されているか     | 高   |
| **機能要求の網羅性** | PRDの機能要求がspecでカバーされているか    | 高   |
| **非機能要求の反映** | PRDの非機能要求がspecに反映されているか    | 中   |
| **用語の一致**    | PRDとspecで同じ用語が使用されているか     | 低   |

#### spec ↔ design の整合性

| チェック対象       | 確認内容                     | 重要度 |
|:-------------|:-------------------------|:----|
| **API定義の一致** | specのAPIがdesignで詳細化されているか | 高   |
| **型定義の一致**   | specの型定義がdesignと一致するか     | 高   |
| **制約事項の考慮**  | specの制約がdesignで考慮されているか   | 中   |

#### design ↔ 実装 の整合性

| チェック対象        | 確認内容                | 重要度 |
|:--------------|:--------------------|:----|
| **API シグネチャ** | 関数名、引数、戻り値が一致するか    | 高   |
| **型定義**       | インターフェース、型が一致するか    | 高   |
| **モジュール構成**   | ディレクトリ・ファイル構造が一致するか | 中   |
| **機能要件**      | 仕様に記載された機能が実装されているか | 高   |
| **技術スタック**    | 記載されたライブラリが使用されているか | 低   |

### 5. 差異の分類

検出した差異を以下のように分類：

**🔴 Critical（即座に対応が必要）**:

- APIシグネチャの不一致（引数、戻り値の型）
- 仕様に記載された機能が未実装
- 型定義の不一致

**🟡 Warning（対応推奨）**:

- モジュール構成の不一致
- ドキュメントに記載のないクラス・関数の存在
- 命名規則の不一致

**🟢 Info（参考情報）**:

- 技術スタックの軽微な差異
- コメント・ドキュメントの不足

## 出力フォーマット

```markdown
## 仕様書整合性チェック結果

### 対象ドキュメント

- `.docs/requirement-diagram/{機能名}.md`（PRD、存在する場合）
- `.docs/specification/{機能名}_spec.md`
- `.docs/specification/{機能名}_design.md`

### チェック結果サマリー

| チェック対象       | 結果               | 件数    |
|:-------------|:-----------------|:------|
| PRD ↔ spec   | 🟢 整合 / 🔴 不整合   | {n} 件 |
| spec ↔ design | 🟢 整合 / 🔴 不整合  | {n} 件 |
| design ↔ 実装  | 🟢 整合 / 🔴 不整合   | {n} 件 |

### PRD ↔ spec の整合性（PRDが存在する場合）

| 要求ID   | PRDの要求内容 | specでの対応      | ステータス           |
|:-------|:---------|:--------------|:----------------|
| FR-001 | {要求内容}   | {対応する機能要件}    | 🟢 整合 / 🔴 未対応   |
| FR-002 | {要求内容}   | 記載なし          | 🔴 未対応          |

### 🔴 Critical（即座に対応が必要）

#### 1. {差異のタイトル}

**仕様書の記載**:

```
// *_spec.md より
doSomething(arg: 文字列): Result
```

**実装コード**:

```
// 実装ファイルより
doSomething(arg: 数値): Result  // 引数の型が異なる
```

**推奨アクション**:

- [ ] 仕様書を更新する（実装が正しい場合）
- [ ] 実装を修正する（仕様書が正しい場合）

---

### 🟡 Warning（対応推奨）

#### 1. {差異のタイトル}

**内容**: {差異の詳細}

**推奨アクション**: {対応方法}

---

### 🟢 Info（参考情報）

- {情報1}
- {情報2}

---

### 未実装機能

仕様書に記載されているが、実装が確認できなかった機能：

| 機能    | 仕様書の記載箇所              | ステータス  |
|:------|:----------------------|:-------|
| {機能名} | `*_spec.md` の {セクション} | 🔴 未実装 |

### 仕様書に未記載の実装

実装されているが、仕様書に記載がない機能：

| 実装         | ファイル         | 推奨アクション         |
|:-----------|:-------------|:----------------|
| {関数名/クラス名} | `{ファイルパス}` | 仕様書に追記 / 不要なら削除 |

### 推奨アクション

1. **Critical** の差異を優先的に解消
2. 仕様書または実装のどちらを修正するか判断
3. 修正後、再度 `/check_spec` を実行して確認

```

## チェック実行タイミング

| タイミング | 推奨アクション |
|:---|:---|
| **実装開始前** | 仕様書の存在と内容を確認 |
| **実装完了時** | 仕様との整合性を検証 |
| **PR作成前** | 最終確認として実行 |
| **定期チェック** | ドキュメントの陳腐化を防止 |

## Serena MCP 統合（オプション）

Serena MCP が有効な場合、セマンティックコード分析による高精度な整合性チェックが可能です。

### 利用条件

- `.mcp.json` に `serena` が設定されていること
- 対象言語の Language Server がサポートされていること（30以上の言語に対応）

### Serena 有効時の追加機能

#### シンボルベースの整合性チェック

| 機能                         | 説明                            |
|:---------------------------|:------------------------------|
| `find_symbol`              | specに記載されたAPI/関数を実装コードから検索   |
| `find_referencing_symbols` | 特定シンボルの使用箇所を把握し、影響範囲を特定      |

#### チェック強化項目

1. **API実装の検証**: specに記載された関数・クラスが実装されているかシンボル検索で確認
2. **シグネチャの一致**: 関数の引数・戻り値の型がspecと一致するか検証
3. **未使用コードの検出**: 実装されているがspecに記載のないシンボルを検出
4. **依存関係の把握**: モジュール間の参照関係を分析

#### Serena 利用時の出力追加

```markdown
### Serena シンボル分析結果

| シンボル           | spec記載 | 実装状況   | 参照数 |
|:----------------|:-------|:-------|:----|
| `createUser`    | ✅      | ✅ 実装済み | 5   |
| `deleteUser`    | ✅      | 🔴 未実装  | 0   |
| `internalHelper`| ❌      | ✅ 実装済み | 3   |
```

### Serena 未設定時の動作

Serena が利用できない場合でも、従来のテキストベース検索（Grep/Glob）で整合性チェックを実行します。
機能は制限されますが、言語非依存で動作します。

## 注意事項

- 仕様書が存在しない場合は、先に `/generate_spec` で作成を推奨
- 差異が多い場合は、仕様書の大幅な更新が必要な可能性あり
- 実装が正しく仕様書が古い場合は、仕様書を更新
- 仕様書が正しく実装が誤っている場合は、実装を修正
