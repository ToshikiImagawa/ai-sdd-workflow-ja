---
description: "仕様書の不明点を9カテゴリでスキャンし、最大5つの質問を生成して仕様を明確化する"
allowed-tools: Read, Write, Edit, Glob, Grep, AskUserQuestion
---

# Clarify - 仕様明確化支援

仕様書（`*_spec.md`）の不明点を9カテゴリでスキャンし、高インパクトな質問を生成して仕様を段階的に明確化します。

## 前提条件

**実行前に必ず `sdd-workflow-ja:sdd-workflow` エージェントの内容を読み込み、AI-SDDの原則を理解してください。**

このコマンドはsdd-workflowエージェントの原則に従って仕様の明確化を支援します。

### ディレクトリパスの解決

**環境変数 `SDD_*` を使用してディレクトリパスを解決します。**

| 環境変数                     | デフォルト値               | 説明              |
|:-------------------------|:---------------------|:----------------|
| `SDD_ROOT`               | `.sdd`               | ルートディレクトリ       |
| `SDD_REQUIREMENT_PATH`   | `.sdd/requirement`   | PRD/要求仕様書ディレクトリ |
| `SDD_SPECIFICATION_PATH` | `.sdd/specification` | 仕様書・設計書ディレクトリ   |
| `SDD_TASK_PATH`          | `.sdd/task`          | タスクログディレクトリ     |

**パス解決の優先順位:**

1. 環境変数 `SDD_*` が設定されている場合はそれを使用
2. 環境変数がない場合は `.sdd-config.json` を確認
3. どちらもない場合はデフォルト値を使用

以下のドキュメントでは、デフォルト値を使用して説明しますが、環境変数または設定ファイルが存在する場合はカスタム値に置き換えてください。

### 補完ツールとの関係

このコマンドは `vibe-detector` スキルと補完関係にあります：

| ツール               | 焦点                   | タイミング     |
|:------------------|:---------------------|:----------|
| **vibe-detector** | 曖昧な指示の検出             | 実装開始前の警告  |
| **clarify**       | 仕様書の不明点の体系的な洗い出しと明確化 | 仕様作成中・更新時 |

## 入力

$ARGUMENTS

### 入力例

```
/clarify user-auth
/clarify auth/user-login                # 階層構造
/clarify task-management --interactive  # 対話モード（質問に1つずつ回答）
```

## 処理フロー

### 1. 対象仕様書の読み込み

フラット構造と階層構造の両方をサポートします。

**フラット構造の場合**:

```
.sdd/requirement/{機能名}.md を読み込む（PRD、存在する場合）
.sdd/specification/{機能名}_spec.md を読み込む（必須）
.sdd/specification/{機能名}_design.md を読み込む（存在する場合）
```

**階層構造の場合**（引数に `/` が含まれる場合）:

```
.sdd/requirement/{親機能名}/{機能名}.md を読み込む（PRD、存在する場合）
.sdd/specification/{親機能名}/{機能名}_spec.md を読み込む（必須）
.sdd/specification/{親機能名}/{機能名}_design.md を読み込む（存在する場合）
```

**⚠️ 命名規則の違いに注意**:

- **requirement 配下**: サフィックスなし（`{機能名}.md`）
- **specification 配下**: `_spec` または `_design` サフィックス必須（`{機能名}_spec.md`）

### 2. 9カテゴリによるスキャン

仕様書を以下の9カテゴリで分析し、不明点を洗い出します：

| カテゴリ          | スキャン対象                     |
|:--------------|:---------------------------|
| **1. 機能範囲**   | スコープ内外の境界が明確か、エッジケースのカバー範囲 |
| **2. データモデル** | 型定義、必須フィールド、制約、データの生存期間    |
| **3. フロー**    | 状態遷移、エラーハンドリング、リトライ戦略      |
| **4. 非機能要件**  | パフォーマンス目標、スケーラビリティ、セキュリティ  |
| **5. 統合**     | 外部システム連携、API契約、依存関係        |
| **6. エッジケース** | 例外処理、境界値、データ欠損時の振る舞い       |
| **7. 制約**     | 技術的制約、ビジネス制約、規制要件          |
| **8. 用語**     | ドメイン固有用語の定義、略語、曖昧な表現       |
| **9. 完了条件**   | 受け入れ基準、テストシナリオ、成功の定義       |

### 3. 不明確度の分類

各カテゴリの項目を以下の3段階で評価：

| ステータス          | 評価          | 説明           |
|:---------------|:------------|:-------------|
| **🟢 Clear**   | 明確に定義されている  | 問題なし         |
| **🟡 Partial** | 部分的に定義されている | 補足が推奨される     |
| **🔴 Missing** | 未定義または曖昧    | 実装前に必ず明確化が必要 |

### 4. 質問の優先順位付け

不明点から最大5つの高インパクト質問を生成：

**質問選定基準**:

| 基準        | 説明                  |
|:----------|:--------------------|
| **影響度**   | 複数のモジュール・機能に影響するか   |
| **リスク**   | 不明確なまま実装すると手戻りが大きいか |
| **ブロッカー** | 実装開始の前提となる情報か       |
| **依存性**   | 他の設計判断に影響を与えるか      |

## 出力フォーマット

````markdown
## 仕様明確化レポート

### 対象ドキュメント

- `.sdd/specification/[{親機能名}/]{機能名}_spec.md`

※ 階層構造の場合、親機能は `index_spec.md`

### 明確度スコア

| カテゴリ   | Clear  | Partial | Missing | スコア     |
|:-------|:-------|:--------|:--------|:--------|
| 機能範囲   | 3      | 1       | 0       | 75%     |
| データモデル | 2      | 2       | 1       | 60%     |
| フロー    | 4      | 0       | 0       | 100%    |
| 非機能要件  | 0      | 2       | 2       | 25%     |
| 統合     | 1      | 0       | 1       | 50%     |
| エッジケース | 1      | 2       | 1       | 50%     |
| 制約     | 2      | 0       | 0       | 100%    |
| 用語     | 3      | 1       | 0       | 75%     |
| 完了条件   | 0      | 1       | 2       | 17%     |
| **総合** | **16** | **9**   | **7**   | **61%** |

### 🔴 Missing（未定義）項目

#### カテゴリ: データモデル

**項目**: ユーザーセッションの有効期限

**現在の記載**: 記載なし

**影響**: セッション管理の実装方針が不明確

---

#### カテゴリ: 非機能要件

**項目**: 同時ログイン数の想定

**現在の記載**: 記載なし

**影響**: パフォーマンステストの基準が定義できない

---

### 🟡 Partial（部分的）項目

#### カテゴリ: エッジケース

**項目**: ネットワークエラー時の振る舞い

**現在の記載**: 「エラーを返す」

**不明点**: リトライ戦略、タイムアウト値、ユーザーへの通知方法が不明

---

### 優先質問（最大5つ）

#### Q1. [高優先度] セッション管理の詳細仕様

**カテゴリ**: データモデル、フロー

**質問**:

- ユーザーセッションの有効期限はどうするか？（例: 30分、1日）
- セッション延長の仕様は？（アクティビティベース or 固定）
- 複数デバイスからの同時ログインは許可するか？

**影響**: 認証フロー全体の実装に影響

**推奨回答形式**:

```
- 有効期限: {時間}
- 延長: {アクティビティベース or 固定 or なし}
- 同時ログイン: {許可 or 禁止}
```

---

#### Q2. [高優先度] パフォーマンス目標の定義

**カテゴリ**: 非機能要件

**質問**:

- 同時ログイン数の想定は？（例: 100, 1000, 10000）
- レスポンスタイムの目標は？（例: 95%ile < 200ms）
- スケーラビリティの要求は？（水平スケール対応の必要性）

**影響**: アーキテクチャ設計、技術選定

**推奨回答形式**:

```
- 同時ログイン数: {数値}
- レスポンスタイム: 95%ile < {ミリ秒}ms
- スケーラビリティ: {必要 or 不要}
```

---

#### Q3. [中優先度] エラーハンドリング戦略

**カテゴリ**: フロー、エッジケース

**質問**:

- ネットワークエラー時のリトライ戦略は？（回数、間隔）
- タイムアウト値の設定は？
- ユーザーへのエラー通知はどうするか？

**影響**: ユーザー体験、システムの堅牢性

**推奨回答形式**:

```
- リトライ: {回数}回、{間隔}秒間隔
- タイムアウト: {秒}秒
- 通知: {トースト or ダイアログ or ログのみ}
```

---

### 回答の統合先

回答は `.sdd/specification/[{親機能名}/]{機能名}_spec.md` に以下のセクションに統合します：

- データモデル関連 → `## データモデル` セクション
- フロー関連 → `## 振る舞い` セクション
- 非機能要件 → `## 非機能要件` セクション（新規追加）
- 用語定義 → `## 用語集` セクション

### 次のアクション

1. **質問に回答**: 上記の質問に回答してください
2. **仕様書を更新**: 回答を元に仕様書を更新します
3. **再スキャン**: `/clarify {機能名}` を再実行して明確度を確認
4. **目標**: 総合スコア 80% 以上で実装開始を推奨

````

## 対話モード（--interactive）

`--interactive` オプションを指定すると、質問に1つずつ回答できます：

```
1. 質問を1つ表示
   ↓
2. ユーザーが回答
   ↓
3. 回答を仕様書に統合
   ↓
4. 次の質問へ（または完了）
```

### 対話モードの利点

- 質問を見ながら段階的に考えられる
- 回答後すぐに仕様書が更新される
- 長い質問リストに圧倒されない

## 更新の推奨タイミング

| タイミング      | 目的              |
|:-----------|:----------------|
| **仕様作成直後** | 初期段階での不明点の洗い出し  |
| **実装開始前**  | 最終確認、残りの不明点をゼロに |
| **仕様変更時**  | 変更による新たな不明点の検出  |
| **レビュー時**  | 第三者視点での不明点の発見   |

## vibe-detector との使い分け

| ツール               | 使用タイミング    | 検出対象      |
|:------------------|:-----------|:----------|
| **vibe-detector** | 実装指示を受けた直後 | 曖昧な指示そのもの |
| **clarify**       | 仕様書作成中・更新時 | 仕様書内の不明点  |

**推奨ワークフロー**:

```
1. ユーザーからタスクを受ける
   ↓
2. vibe-detector で曖昧な指示を検出
   ↓
3. 仕様書を作成/更新
   ↓
4. clarify で不明点をスキャン
   ↓
5. 質問に回答して仕様を明確化
   ↓
6. 明確度スコア 80% 以上で実装開始
```

## 注意事項

- 仕様書が存在しない場合は、先に `/generate_spec` で作成を推奨
- 明確度スコア 80% 未満での実装開始はリスクが高い
- 回答が得られない質問は `task/` に「未解決の質問」として記録
- 回答を仕様書に統合する際は、命名規則（`_spec` サフィックス）に注意