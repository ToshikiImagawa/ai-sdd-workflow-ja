---
description: "プロジェクトの非交渉原則を定義・管理し、他ドキュメントとの同期を検証する"
allowed-tools: Read, Write, Edit, Glob, Grep, Skill
---

# Constitution - プロジェクト原則管理

プロジェクトの非交渉原則を定義し、すべての仕様書・設計書がこれに従っているかを検証します。

## 前提条件

**実行前に必ず `sdd-workflow-ja:sdd-workflow` エージェントの内容を読み込み、AI-SDDの原則を理解してください。**

このコマンドはsdd-workflowエージェントの原則に従ってプロジェクト原則を管理します。

### ディレクトリパスの解決

**環境変数 `SDD_*` を使用してディレクトリパスを解決します。**

| 環境変数                     | デフォルト値               | 説明              |
|:-------------------------|:---------------------|:----------------|
| `SDD_ROOT`               | `.sdd`               | ルートディレクトリ       |
| `SDD_REQUIREMENT_PATH`   | `.sdd/requirement`   | PRD/要求仕様書ディレクトリ |
| `SDD_SPECIFICATION_PATH` | `.sdd/specification` | 仕様書・設計書ディレクトリ   |
| `SDD_TASK_PATH`          | `.sdd/task`          | タスクログディレクトリ     |

**パス解決の優先順位:**

1. 環境変数 `SDD_*` が設定されている場合はそれを使用
2. 環境変数がない場合は `.sdd-config.json` を確認
3. どちらもない場合はデフォルト値を使用

以下のドキュメントでは、デフォルト値を使用して説明しますが、環境変数または設定ファイルが存在する場合はカスタム値に置き換えてください。

## プロジェクト原則とは

プロジェクト原則は、**すべての設計判断の基盤となる非交渉原則**を定義します。

### 原則の特徴

| 特徴       | 説明                       |
|:---------|:-------------------------|
| **非交渉**  | 議論の余地がない。変更には慎重な検討が必要    |
| **永続的**  | プロジェクト全体で一貫して適用される       |
| **階層的**  | 上位原則が下位原則に優先する           |
| **検証可能** | 仕様書・設計書が原則に従っているか自動検証できる |

### 原則の例

| 原則カテゴリ      | 原則例                                       |
|:------------|:------------------------------------------|
| **アーキテクチャ** | Library-First（ライブラリ優先）、Clean Architecture |
| **開発手法**    | Test-First（テストファースト）、Specification-Driven |
| **品質基準**    | Test Coverage > 80%、Zero Runtime Errors   |
| **技術制約**    | TypeScript Only、No Any Types              |
| **ビジネス原則**  | Privacy by Design、Accessibility First     |

## 入力

$ARGUMENTS

### 入力例

```
/constitution init                      # 原則定義ファイルを初期化
/constitution validate                  # 原則準拠を検証
/constitution add "Library-First"       # 新しい原則を追加
/constitution bump-version major        # メジャーバージョンアップ
```

## 処理フロー

### 1. 初期化（init）

プロジェクトに原則定義ファイルを作成：

```bash
/constitution init
```

**生成ファイル**: `.sdd/CONSTITUTION.md`

**使用スキル**: `sdd-workflow-ja:sdd-templates`

**処理フロー**:

1. `.sdd/CONSTITUTION.md` が既に存在するか確認
2. 存在する場合: スキップ（既存の原則を尊重）
3. 存在しない場合:
   - `sdd-workflow-ja:sdd-templates` スキルの `templates/constitution_template.md` を参照
   - プロジェクトコンテキスト（言語、フレームワーク、ドメイン）を分析
   - コンテキストに基づいてカスタマイズされた原則を生成

**内容**: プロジェクトに合わせてカスタマイズされたテンプレート

### 2. 原則の追加（add）

新しい原則を原則に追加：

```bash
/constitution add "Library-First"
```

**処理**:

1. 原則の詳細をユーザーに確認
2. 適切なカテゴリに追加
3. バージョンをマイナーアップ（例: 1.0.0 → 1.1.0）
4. 変更履歴に記録

### 3. 現在の原則を表示（show）

**コマンド**: `/constitution show`

**出力内容**:

- 現在のバージョン
- すべての原則
- 最近の変更
- 準拠状況

### 4. 原則の更新（update）

**コマンド**: `/constitution update`

**インタラクティブプロンプト**:

```
変更の種類は？
1. 新しい原則を追加（MAJOR）
2. 既存原則を変更（MAJOR）
3. 既存原則を明確化（MINOR）
4. 実施方法を更新（MINOR）

> 1

新しい原則を説明してください:
> ...

根拠:
> ...

どのように実施されますか？
> ...

例外はありますか？
> ...

提案された変更をレビュー:
[フォーマットされた原則を表示]

確認しますか (y/n)?
> y

✓ 原則が更新されました
  バージョン: 1.0.0 → 2.0.0
  変更: 原則P4を追加
```

**バージョンアップルール**:

| 変更種別    | バージョンへの影響     | 例             |
|:--------|:--------------|:--------------|
| 原則を追加   | MAJOR (X.y.z) | 1.0.0 → 2.0.0 |
| 原則を変更   | MAJOR (X.y.z) | 1.0.0 → 2.0.0 |
| 原則を削除   | MAJOR (X.y.z) | 1.0.0 → 2.0.0 |
| 原則を明確化  | MINOR (x.Y.z) | 1.0.0 → 1.1.0 |
| 実施方法を更新 | MINOR (x.Y.z) | 1.0.0 → 1.1.0 |
| 誤字を修正   | PATCH (x.y.Z) | 1.0.0 → 1.0.1 |

### 5. 検証（validate）

すべての仕様書・設計書が原則に従っているか検証：

```bash
/constitution validate
```

**検証対象**:

- `.sdd/requirement/**/*.md`
- `.sdd/specification/**/*_spec.md`
- `.sdd/specification/**/*_design.md`
- `.sdd/PRD_TEMPLATE.md`
- `.sdd/SPECIFICATION_TEMPLATE.md`
- `.sdd/DESIGN_DOC_TEMPLATE.md`

**検証項目**:

| 検証項目          | 確認内容                 |
|:--------------|:---------------------|
| **原則の言及**     | 仕様書・設計書で原則が言及されているか  |
| **原則への準拠**    | 実装判断が原則に従っているか       |
| **矛盾の検出**     | 原則に反する記述がないか         |
| **テンプレートの同期** | テンプレートが最新の原則を反映しているか |

**検証チェック**:

````markdown
# 原則準拠レポート

**原則バージョン**: 2.0.0
**検証日**: YYYY-MM-DD
**プロジェクト**: {プロジェクト名}

## 準拠サマリー

| 原則 | 状態 | スコア |
|:---|:---|:---|
| P1: 仕様ファースト開発 | ✓ 準拠 | 95% |
| P2: テストファースト | ⚠ 部分準拠 | 78% |
| P3: ライブラリファースト | ✓ 準拠 | 100% |
| P4: APIバージョニング | ✗ 非準拠 | 45% |

## 詳細分析

### P1: 仕様ファースト開発

**状態**: ✓ 準拠 (95%)

**検証**:

- [x] すべての機能に仕様書が存在
- [x] 実装前に仕様書が存在
- [ ] 2つのレガシー機能に仕様書がない（user-profile、settings）

**推奨事項**:

- レガシー機能の仕様書を作成: user-profile、settings
- これらの機能に対して `/generate_spec` を実行

---

### P2: テストファースト実装

**状態**: ⚠ 部分準拠 (78%)

**検証**:

- [x] テストカバレッジ ≥80% (現在: 78.3%)
- [ ] すべての機能がTDDコミットパターンに従っていない
- [x] コードレビューにテスト検証が含まれている

**推奨事項**:

- カバレッジを1.7%向上させて閾値を満たす
- 新規コードのコミットメッセージ規約を徹底
- user-profileモジュールに注力（現在のカバレッジ: 65%）

---

### P4: APIバージョニング

**状態**: ✗ 非準拠 (45%)

**検証**:

- [ ] APIの45%のみがバージョン番号を含む
- [ ] バージョニング戦略が文書化されていない
- [x] 破壊的変更は文書化されている

**推奨事項**:

- 原則にAPIバージョニング戦略を文書化
- すべてのAPIエンドポイントにバージョンプレフィックスを追加
- 破壊的変更の移行ガイドを作成

---

## アクションアイテム

### クリティカル（デプロイをブロック）

1. **P4準拠**: APIバージョニングの実装
    - すべてのエンドポイントに `/api/v1/` プレフィックスを追加
    - バージョニング戦略を文書化
    - クライアントコードを更新

### 優先度高

2. **P2準拠**: テストカバレッジを80%以上に向上
    - user-profileモジュールに注力
    - エッジケースのテストを追加

3. **P1準拠**: 欠落している仕様書を作成
    - user-profile機能
    - settings機能

### 優先度中

4. コミットメッセージ規約の徹底
5. コードレビューチェックリストの更新

## 次のステップ

1. クリティカルなアクションアイテムに対処
2. 修正後に検証を再実行
3. パターンが現れた場合は原則を更新

````

### 6. 原則の同期（sync）

**コマンド**: `/constitution sync`

**目的**: 原則が他のドキュメントに反映されていることを確認

**アクション**:

1. **仕様書テンプレートの更新**:
    - 原則への参照を追加
    - 制約セクションを更新
    - 用語を同期

2. **設計書テンプレートの更新**:
    - 原則準拠セクションを追加
    - 意思決定フレームワークを更新
    - アーキテクチャ制約を同期

3. **タスクテンプレートの更新**:
    - 準拠検証タスクを追加
    - 完了基準を更新
    - 関連する原則を参照

4. **チェックリストテンプレートの更新**:
    - 原則検証項目を追加
    - 優先順位を更新
    - 品質ゲートを同期

**出力**:

````markdown
# 原則同期レポート

## 更新されたドキュメント

- [x] `.sdd/SPECIFICATION_TEMPLATE.md`
    - APIセクションにP1参照を追加
    - P3を含むように制約を更新

- [x] `.sdd/DESIGN_DOC_TEMPLATE.md`
    - 「原則準拠」セクションを追加
    - 原則に合わせて意思決定フレームワークを更新

- [x] `skills/sdd-templates/templates/checklist_template.md`
    - 原則検証項目を追加
    - CHK-CONST-001: P1検証
    - CHK-CONST-002: P2検証
    - CHK-CONST-003: P3検証

## 同期状態

✓ すべてのドキュメントが原則v2.0.0と同期されました

````

### 7. バージョン管理（bump-version）

原則のバージョンを更新：

```bash
/constitution bump-version major   # メジャーバージョンアップ（破壊的変更）
/constitution bump-version minor   # マイナーバージョンアップ（原則追加）
/constitution bump-version patch   # パッチバージョンアップ（誤字修正）
```

**セマンティックバージョニング**:

| バージョン種別 | 用途                  | 例             |
|:--------|:--------------------|:--------------|
| Major   | 既存原則の削除・大幅変更（破壊的変更） | 1.0.0 → 2.0.0 |
| Minor   | 新しい原則の追加            | 1.0.0 → 1.1.0 |
| Patch   | 原則の表現修正、誤字修正        | 1.0.0 → 1.0.1 |

## 原則定義ファイルの構造

````markdown
# プロジェクト原則

## メタ情報

| 項目     | 内容         |
|:-------|:-----------|
| バージョン  | 1.2.0      |
| 作成日    | 2024-01-01 |
| 最終更新日  | 2024-06-15 |

## 原則階層

```

1. ビジネス原則（最優先）
   ↓
2. アーキテクチャ原則
   ↓
3. 開発手法原則
   ↓
4. 技術制約

```

優先度が高い原則が低い原則に優先します。

---

## 1. ビジネス原則（最優先）

### B-001: Privacy by Design

**原則**: ユーザーのプライバシーを最優先に考慮する

**適用範囲**: すべての機能・データモデル

**検証方法**:

- [ ] 個人情報の収集は最小限か
- [ ] データ保持期間は定義されているか
- [ ] ユーザーによるデータ削除が可能か

**違反例**:

- 不要な個人情報を収集する
- データ保持期間が無期限

**準拠例**:

- 必要最小限の情報のみ収集
- 明確なデータ保持期間を定義

---

### B-002: Accessibility First

**原則**: すべてのユーザーがアクセス可能な設計を行う

**適用範囲**: UI/UX設計

**検証方法**:

- [ ] WCAG 2.1 AA 準拠
- [ ] キーボード操作のみで完結可能
- [ ] スクリーンリーダー対応

---

## 2. アーキテクチャ原則

### A-001: Library-First

**原則**: 可能な限り既存ライブラリを活用し、車輪の再発明を避ける

**適用範囲**: すべての実装

**検証方法**:

- [ ] 新規実装前に既存ライブラリを調査したか
- [ ] 自作する場合の明確な理由があるか

**違反例**:

- ライブラリ調査なしで自作実装

**準拠例**:

- 既存ライブラリを調査し、適切なものを選定
- 自作する場合は理由を設計書に明記

---

### A-002: Clean Architecture

**原則**: レイヤー分離を徹底し、依存方向を外側から内側へ単方向にする

**適用範囲**: すべてのモジュール設計

**検証方法**:

- [ ] Presentation → Application → Domain → Infrastructure
- [ ] 内側のレイヤーが外側のレイヤーに依存していない

---

## 3. 開発手法原則

### D-001: Test-First

**原則**: テストを先に書いてから実装する（TDD）

**適用範囲**: すべてのコア機能

**検証方法**:

- [ ] 実装前にテストケースが作成されている
- [ ] テストカバレッジ > 80%

---

### D-002: Specification-Driven

**原則**: 仕様書なしで実装しない

**適用範囲**: すべての新機能・変更

**検証方法**:

- [ ] `*_spec.md` が存在する
- [ ] `*_design.md` が存在する

---

## 4. 技術制約

### T-001: TypeScript Only

**原則**: すべてのコードはTypeScriptで記述する

**適用範囲**: すべてのソースコード

**検証方法**:

- [ ] .js ファイルが存在しない
- [ ] any 型を使用していない

---

### T-002: No Runtime Errors

**原則**: 実行時エラーを許容しない（コンパイル時に検出）

**適用範囲**: すべてのコード

**検証方法**:

- [ ] strict モード有効
- [ ] 型ガードの適切な使用
- [ ] Error Boundary の実装

---

## 変更履歴

### v1.2.0 (2024-06-15)

- [追加] T-002: No Runtime Errors

### v1.1.0 (2024-03-10)

- [追加] A-002: Clean Architecture
- [更新] D-001: テストカバレッジ目標を 80% に変更

### v1.0.0 (2024-01-01)

- 初版作成
````

**保存先**: `.sdd/CONSTITUTION.md`

## 出力フォーマット

### 初回作成時

````markdown
✓ プロジェクト原則を作成しました

**バージョン**: 1.0.0
**場所**: `.sdd/CONSTITUTION.md`

## 定義された原則

- P1: 仕様ファースト開発
- P2: テストファースト実装
- P3: ライブラリファースト

## 次のステップ

1. チームで原則をレビュー
2. CI/CDパイプラインに統合
3. コードレビューチェックリストを更新
4. `/constitution sync` を実行してテンプレートを更新
5. `/constitution validate` を実行して現在の準拠状況を確認

## 実施

定義された原則は以下を通じて実施されます:

- プリコミットフック（基本チェック）
- CI/CDパイプライン（包括的検証）
- コードレビュープロセス（手動検証）

````

## 検証結果の出力フォーマット

````markdown
## 原則準拠検証結果

### 原則バージョン

v1.2.0

### 検証対象

- `.sdd/specification/**/*_spec.md` (15 files)
- `.sdd/specification/**/*_design.md` (15 files)
- テンプレートファイル (2 files)

### 検証サマリー

| カテゴリ      | 検証項目数 | 準拠    | 違反    | 未言及   |
|:----------|:------|:------|:------|:------|
| ビジネス原則    | 2     | 2     | 0     | 0     |
| アーキテクチャ原則 | 2     | 1     | 1     | 0     |
| 開発手法原則    | 2     | 2     | 0     | 0     |
| 技術制約      | 2     | 1     | 0     | 1     |
| **総合**    | **8** | **6** | **1** | **1** |

### 🔴 違反項目

#### 原則: A-001 Library-First

**違反箇所**: `.sdd/specification/auth/user-login_design.md`

**違反内容**:

```md
## パスワードハッシュ化

独自のハッシュアルゴリズムを実装する。
```

**問題**: 既存ライブラリ（bcrypt等）の調査なしで自作実装を選択

**推奨アクション**:

- [ ] bcrypt, argon2 等の既存ライブラリを検討
- [ ] 自作が必要な場合は明確な理由を記載

---

### 🟡 未言及項目

#### 原則: T-002 No Runtime Errors

**未言及箇所**: `.sdd/specification/payment/checkout_design.md`

**問題**: Error Boundary や型ガードについての記述がない

**推奨アクション**:

- [ ] エラーハンドリング戦略を設計書に追記
- [ ] Error Boundary の実装計画を記載

---

### ✅ 準拠項目

- B-001: Privacy by Design (15 / 15 files)
- B-002: Accessibility First (15 / 15 files)
- A-002: Clean Architecture (14 / 15 files)
- D-001: Test-First (15 / 15 files)
- D-002: Specification-Driven (15 / 15 files)
- T-001: TypeScript Only (14 / 15 files)

---

### テンプレート同期状態

| テンプレート                           | 原則バージョン | 同期状態           |
|:---------------------------------|:--------|:---------------|
| `.sdd/SPECIFICATION_TEMPLATE.md` | v1.2.0  | ✅ 最新           |
| `.sdd/DESIGN_DOC_TEMPLATE.md`    | v1.1.0  | 🟡 要更新（v1.2.0） |

**推奨アクション**:

- [ ] DESIGN_DOC_TEMPLATE.md に T-002 の言及を追加

---

### 次のアクション

1. **違反項目の修正**:
    - `.sdd/specification/auth/user-login_design.md` を修正

2. **未言及項目の追記**:
    - `.sdd/specification/payment/checkout_design.md` にエラーハンドリング戦略を追記

3. **テンプレートの更新**:
    - `.sdd/DESIGN_DOC_TEMPLATE.md` を v1.2.0 に更新

4. **再検証**:
    - 修正後、`/constitution validate` を再実行

````

## 原則と他ドキュメントの関係

### 同期すべきドキュメント

| ドキュメント                           | 同期内容            |
|:---------------------------------|:----------------|
| `.sdd/SPECIFICATION_TEMPLATE.md` | 原則への言及セクションを追加  |
| `.sdd/DESIGN_DOC_TEMPLATE.md`    | 原則準拠のチェックリストを追加 |
| `*_spec.md`                      | 原則に基づいた設計を記述    |
| `*_design.md`                    | 原則への準拠を明記       |

### 同期の検証

`/constitution validate` を実行すると、以下を自動検証：

1. **テンプレートの原則バージョン**: 最新原則を反映しているか
2. **仕様書での原則言及**: 各原則が適切に言及されているか
3. **設計判断の準拠**: 設計判断が原則に従っているか

## 活用シーン

| シーン           | コマンド                               | 用途              |
|:--------------|:-----------------------------------|:----------------|
| **プロジェクト開始時** | `/constitution init`               | 原則定義ファイルを作成       |
| **新しい原則追加**   | `/constitution add`                | 原則を追加し、バージョンアップ |
| **仕様書作成前**    | `/constitution validate`           | 最新原則を確認         |
| **レビュー前**     | `/constitution validate`           | 原則準拠を検証         |
| **大きな方針変更**   | `/constitution bump-version major` | メジャーバージョンアップ    |

## 原則の変更ルール

### 変更プロセス

```

1. 変更提案（Issue等で議論）
   ↓
2. チーム承認
   ↓
3. 原則定義ファイルを更新
   ↓
4. バージョンアップ
   ↓
5. 影響を受けるドキュメントを更新
   ↓
6. /constitution validate で検証

```

### メジャーバージョンアップの条件

以下のいずれかに該当する場合はメジャーバージョンアップが必要：

- 既存原則の削除
- 既存原則の大幅な変更
- 原則の優先順位の変更
- 既存の仕様書・設計書に破壊的な影響を与える変更

## ベストプラクティス

### 原則を作成するタイミング

| プロジェクトステージ   | 推奨アクション              |
|:-------------|:---------------------|
| **新規プロジェクト** | セットアップフェーズで原則を作成     |
| **既存プロジェクト** | プラクティスを形式化するために原則を作成 |
| **チームの拡大**   | 一貫性を確保するために原則を作成     |
| **品質問題**     | 基準を上げるために原則を作成       |

### 原則設計ガイドライン

**良い原則は**:

- ✓ 明確で曖昧さがない
- ✓ 実施可能（チェックできる）
- ✓ 正当化されている（明確な根拠がある）
- ✓ 実用的（従うことができる）
- ✓ 具体的（曖昧でない）

**悪い原則は**:

- ✗ 曖昧（「良いコードを書く」）
- ✗ 実施不可能（「創造的であれ」）
- ✗ 正当化されていない（「私が言ったから」）
- ✗ 非実用的（「すべてに100%のカバレッジ」）
- ✗ 矛盾している（他の原則と衝突）

### 原則 vs. スタイルガイド

| ドキュメント      | 目的       | 例                    |
|:------------|:---------|:---------------------|
| **原則**      | 非交渉原則    | TDD、仕様ファースト、セキュリティ基準 |
| **スタイルガイド** | コーディング規約 | 命名、フォーマット、コメントスタイル   |

両方とも重要ですが、原則が優先されます。

## AI-SDDワークフローとの統合

```

原則（プロジェクトレベルの原則）
↓
PRD（ビジネス要件）
↓
仕様書（論理設計）
↓
設計書（技術実装）
↓
実装（コード）

```

定義された原則は各レベルでチェックされます。

## 高度な機能

### 原則テンプレート

一般的な原則テンプレートは、以下のように適応できます:

````markdown
### P{n}: {原則名}

**原則**: {1文の宣言}

**根拠**: {なぜこれが重要か}

**実施**:

- {どのようにチェックされるか}
- {使用されるツール/プロセス}

**例外**: {これが適用されない場合}

**追加バージョン**: {X.Y.Z}
````

### コードとしての原則

原則を機械可読形式にエクスポート:

```
/constitution export --format json
```

出力: `.sdd/constitution.json`

```json
{
  "version": "1.0.0",
  "principles": [
    {
      "id": "P1",
      "name": "Specification-First",
      "enforceable": true,
      "checks": [
        {
          "type": "file_exists",
          "pattern": ".sdd/specification/*_spec.md"
        }
      ]
    }
  ]
}
```

CI/CDパイプラインで自動検証に使用できます。

## 注意事項

- 原則定義ファイルは `.sdd/` 直下に配置（`.sdd/CONSTITUTION.md`）
- 原則は生きているドキュメントであり、チームが学ぶにつれて更新される
- すべての変更をバージョン管理して進化を追跡
- メジャーバージョン変更にはコード移行が必要な場合がある
- 原則は少数（3-7個）で影響力の高いものにする
- 原則が多すぎると無視される
- 原則の関連性を四半期ごとにレビュー
- 原則は AI 生成コードにも適用される
- PRチェックで `/constitution validate` を使用
- 原則違反はマージをブロックすべき（明示的なオーバーライドプロセスあり）
- 原則の変更はチーム全体で合意の上で行う
- 既存の仕様書・設計書への影響を常に考慮する
- 原則は「なぜその原則が必要か」を明記する
- 検証可能な形で原則を定義する
- 原則バージョンはセマンティックバージョニングに従う
